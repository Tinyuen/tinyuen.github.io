---
title: Nginx + SSL é…ç½®å®ç° https è®¿é—®
categories:
- æœåŠ¡ç«¯
tags:
- Nginx
date: 2020-03-19 00:36:46
---

æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•é€šè¿‡ Nginx æ¥é…ç½® SSLï¼Œå¼€å¯æ¥å£çš„ https è°ƒç”¨ã€‚å¦‚æœä½ æ­£åœ¨å¼€å‘å¾®ä¿¡å°ç¨‹åºï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå¸®å¾—ä¸Šå¿™ã€‚
<!--more-->
### èƒŒæ™¯
æ¥¼ä¸»å‰é˜µå­å†™å°ç¨‹åºï¼Œæ¥å£åœ¨ Http ç¯å¢ƒæµ‹è¯•é€šè¿‡ï¼ŒäºŒçº§åŸŸåè§£æå®Œæ¯•ï¼ŒIPæ˜ å°„å®Œæ¯•ï¼Œå¿ƒæƒ³ä¸‡äº‹å¤§å‰ï¼Œå‘å¸ƒä¸Šçº¿ã€‚è°æ–™å¿˜è®°äº†å°ç¨‹åºç”Ÿäº§ç¯å¢ƒæ¥å£å¿…é¡»ä½¿ç”¨ Https åè®®ã€‚ç™¾å¯†ä¸€ç–... çœ‹æ¥åªèƒ½å¹²å¹²è¿ç»´çš„æ´»å„¿äº†ã€‚è™½ç„¶æœ€åæå®šäº†ï¼Œä¸è¿‡è¿˜æ˜¯è¸©äº†äº›å‘çš„ï¼Œè®°å½•ä¸‹ã€‚

æ‰€ä»¥ä»Šå¤©è¦å®ç°åŠŸèƒ½å°±æ˜¯é€šè¿‡æˆ‘çš„äºŒçº§åŸŸå `https://api.tianxiaohu.online` æ¥è®¿é—®æœåŠ¡å™¨æ¥å£ã€‚

### ä½ éœ€è¦å‡†å¤‡ï¼š
è¿™éƒ¨åˆ†ä¸æ˜¯ä¸»è¦çš„ï¼Œæ‰€ä»¥éœ€è¦ä½ è‡ªè¡Œæå®šï¼Œ
> Â· åŸŸåï¼ˆæ¥¼ä¸»åŸŸåé˜¿é‡Œäº‘ä¹°çš„ï¼‰
> Â· å°†åŸŸåè§£æåˆ°ä¸»æœºIP
> Â· æœåŠ¡å™¨å®‰è£…å¥½ Nginx ç¯å¢ƒï¼ˆå®‰è£…æ—¶åŠ¡å¿…å®‰è£…sslæ¨¡å— â€“with-http_ssl_moduleï¼Œå¾ˆç®€å•ï¼Œä¸ä¼šçš„è‡ªè¡ŒGoogleï¼‰

### ä¸ºä½ çš„åŸŸåç”³è¯· SSL è¯ä¹¦
ä¸ºåŸŸåç”³è¯· SSL è¯ä¹¦å…¶å®å¹¶ä¸å¤æ‚ã€‚æ€»æ‰€å‘¨çŸ¥ï¼Œå¤§éƒ¨åˆ†çš„è¯ä¹¦æä¾›å•†æ˜¯éœ€è¦æ”¶è´¹çš„ï¼Œä¾¿å®œçš„ä¹Ÿå¾—åƒæŠŠå—ä¸€å¹´ã€‚å¯¹äºæ™®é€šä¸ªäººå¼€å‘è€…è€Œè¨€ç¡®å®æ˜¯ä¸€ç¬”ä¸å°çš„å¼€æ”¯ã€‚å½“ç„¶äº†ï¼Œå…è´¹çš„è¯ä¹¦ä¹Ÿä¸æ˜¯æ²¡æœ‰ï¼Œæ— éå°±æ˜¯å®‰å…¨æ€§å’Œç¨³å®šæ€§ä¸å¦‚æ”¶è´¹çš„ã€‚å…¶å®å¹³æ—¶ä¸ªäººä½¿ç”¨è¿˜æ˜¯å®Œå…¨å¯ä»¥ cover çš„ã€‚
å¦‚æœä½ ä½¿ç”¨çš„æ˜¯é˜¿é‡Œäº‘ï¼Œé‚£ä¹ˆåœ¨é˜¿é‡Œäº‘ä¸Šå°±æœ‰å…è´¹çš„è¯ä¹¦å¯ä»¥[è´­ä¹°](https://common-buy.aliyun.com/?spm=5176.2020520163.c1583915649459.d1583915649459_0.d94056a7EtHbw3.d94056a7EtHbw3&commodityCode=cas#/buy)ã€‚è´­ä¹°å®Œï¼ŒæŒ‰ç…§é˜¿é‡Œäº‘çš„ä½¿ç”¨æ–‡æ¡£ï¼Œä¸ºè‡ªå·±çš„åŸŸåç”³è¯·è¯ä¹¦å°±okäº†ï¼Œä¸èµ˜è¿°~

### é…ç½® Nginx
å› ä¸ºä¹‹å‰ä½ å·²ç»åŸŸåè§£æåˆ°äº†ä½ çš„ä¸»æœºIPï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦ Nginx å¸®æˆ‘åšçš„äº‹æƒ…å°±æ˜¯ç›‘å¬æœåŠ¡å™¨çš„443ç«¯å£ï¼Œç„¶åè½¬å‘åˆ°ä¸»æœºçš„æ¥å£æœåŠ¡ä¸Šã€‚ä»è€Œå®ç°é€šè¿‡httpsè®¿é—®æ¥å£ã€‚Nginxå…·ä½“çš„å®‰è£…é…ç½®ä¹Ÿä¸è¿‡å¤šæè¿°ï¼ŒæŒ‰ç…§æ–‡æ¡£æ¥å°±å¥½ï¼Œç›¸ä¿¡ä¸ä¼šéš¾å€’å¤§å®¶ï¼Œè¿™é‡Œåªè¯´ä¸€ä¸ªæ¯”è¾ƒæ£˜æ‰‹çš„æƒ…å†µï¼Œå°±æ˜¯æ­¤å‰å·²ç»å®‰è£…å¥½äº†Nginxï¼Œä½†æ˜¯å¹¶æ²¡æœ‰é™„å¸¦å®‰è£…SSLåŒ…ã€‚

è¿™ç§æƒ…å†µæ˜¯æœ‰åŠæ³•è§£å†³çš„ï¼Œå¯ä»¥åœ¨ä¸å¸è½½ Nginx çš„æƒ…å†µä¸‹å®ŒæˆSSLåŒ…çš„é…ç½®ã€‚è¯¦ç»†è¯·çœ‹[ã€Šå¦‚ä½•ä¸ºå·²ç»å®‰è£…å¥½çš„ Nginx æ·»åŠ  SSL æ¨¡å—ã€‹]()

å¼€å§‹å‰å…ˆè¯´æ˜ä¸‹æ¥¼ä¸»çš„ç¯å¢ƒæƒ…å†µï¼ˆä¸åŒç¯å¢ƒå¯èƒ½æ“ä½œæœ‰å·®å¼‚ï¼‰ï¼š
> Â· æœåŠ¡å™¨ï¼šCentOS 7.x
> Â· æœ¬åœ°æœºå™¨ï¼šMacBook Pro
> Â· Nginx ç‰ˆæœ¬ï¼š1.12.0
> Â· Nginx å®‰è£…ç›®å½•ï¼š/usr/local/nginx

#### 1. ä¸‹è½½ SSL è¯ä¹¦ï¼Œå­˜æ”¾åˆ°æœåŠ¡å™¨
å¦‚æœä½ çš„åŸŸå https å·²ç»å¼€é€šï¼Œé‚£ä¹ˆåœ¨å¯¹åº”çš„å¹³å°ï¼ˆæˆ‘çš„æ˜¯é˜¿é‡Œäº‘ï¼‰å»ä¸‹è½½è¯ä¹¦æ–‡ä»¶ã€‚åœ¨ä¸‹è½½çš„æ—¶å€™è¦æ³¨æ„é€‰æ‹©å¯¹åº”çš„æœåŠ¡å™¨ç±»å‹ã€‚æœ‰ Tomcatã€Apacheã€IISã€Nginxç­‰ï¼Œæœ¬æ–‡ä¸»è¦è®²è§£Nginxï¼Œæ‰€ä»¥é€‰æ‹©ä¸‹è½½Nginxå¯¹åº”çš„è¯ä¹¦æ–‡ä»¶åˆ°ä½ æœ¬åœ°ã€‚

ä¸‹è½½åä½ ä¼šå¾—åˆ°ä¸¤ä¸ªè¯ä¹¦æ–‡ä»¶ï¼Œå‡è®¾ä¸º `cert.pem` å’Œ `cert.key`ã€‚æ¥¼ä¸»å­˜æ”¾åˆ°æœ¬åœ° `/Users/Toy/ssl` ç›®å½•ã€‚

#### 2. å°†è¯ä¹¦æ–‡ä»¶æ¨é€åˆ°æœåŠ¡å™¨
ä¸‹è½½å¥½çš„è¯ä¹¦éœ€è¦æ”¾ç½®åˆ°æœåŠ¡å™¨ä¸Šï¼Œå¯ä»¥è‡ªå·±æ‰¾ä¸ªç›®å½•å­˜æ”¾ã€‚æ¥¼ä¸»è¿™é‡Œæ”¾åˆ°Nginxçš„å®‰è£…ç›®å½•é‡Œ `/usr/local/nginx/cert/ssl`ã€‚

åˆ›å»ºè¯ä¹¦å­˜æ”¾ç›®å½•ï¼ˆç›®å½•å¯è‡ªé€‰ï¼‰ï¼š
```javascriptt
cd /usr/local/nginx
mkdir cert
cd cert/
mkdir ssl
```

æ¨é€æœ¬åœ°è¯ä¹¦æ–‡ä»¶è‡³æœåŠ¡å™¨æ–°åˆ›å»ºçš„ç›®å½•ï¼š

æ¨é€æ–¹æ³•æ¯”è¾ƒå¤šï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨FTPç›´æ¥ä¸Šä¼ ï¼Œä¸è¿‡éœ€è¦å…ˆåœ¨æœåŠ¡å™¨ä¸Šé…ç½®å¥½FTPã€‚æ¥¼ä¸»æ¯”è¾ƒå–œæ¬¢ç®€å•çš„ SCP å‘½ä»¤ï¼Œå°±æ˜¯secure copyï¼Œæ˜¯ç”¨æ¥è¿›è¡Œè¿œç¨‹æ–‡ä»¶æ‹·è´çš„ã€‚æ•°æ®ä¼ è¾“ä½¿ç”¨ sshï¼Œå¹¶ä¸”å’Œssh ä½¿ç”¨ç›¸åŒçš„è®¤è¯æ–¹å¼ï¼Œæä¾›ç›¸åŒçš„å®‰å…¨ä¿è¯ã€‚ 

å‘½ä»¤æ ¼å¼ï¼š
>scp \[å‚æ•°\] <æºåœ°å€ï¼ˆç”¨æˆ·å@IPåœ°å€æˆ–ä¸»æœºåï¼‰>:<æ–‡ä»¶è·¯å¾„> <ç›®çš„åœ°å€ï¼ˆç”¨æˆ·å @IP åœ°å€æˆ–ä¸»æœºåï¼‰>:<æ–‡ä»¶è·¯å¾„> 

æ‰¾åˆ°ä¹‹å‰æœ¬åœ°å­˜æ”¾è¯ä¹¦çš„ç›®å½• `/Users/Toy/ssl`ï¼Œç„¶ååœ¨ç»ˆç«¯æ‰§è¡Œè„šæœ¬ã€‚

```javascriptt
scp /Users/Toy/ssl/cert.pem root@123.123.123.123:/usr/local/nginx/cert/ssl/cert.pem
scp /Users/Toy/ssl/cert.key root@123.123.123.123:/usr/local/nginx/cert/ssl/cert.key
```

ä»¥ä¸Šä¸¤æ¡å‘½ä»¤å³å¯æå®šã€‚

#### 2. å¼€æ”¾ 443ã€80 ç«¯å£
å¼€æ”¾ç«¯å£æ–¹æ³•ä¹Ÿå¾ˆå¤šï¼Œå¦‚æœå›¾çœäº‹ï¼Œå¯ä»¥ç›´æ¥åœ¨é˜¿é‡Œäº‘æ§åˆ¶å°çš„å®‰å…¨ç»„é‡Œé¢å¼€æ”¾443ç«¯å£æˆ–è€…80ç«¯å£ã€‚ï¼ˆæ­¤æ–¹æ³•å¼€å¯åè®°å¾—é‡å¯æœåŠ¡å™¨ï¼Œæ¥¼ä¸»å¼€å§‹ä¹Ÿæ˜¯é€šè¿‡æ­¤æ–¹æ³•å¼€å¯ï¼Œç„¶åä¸€ç›´ä¸ç”Ÿæ•ˆï¼Œå‘äº†æˆ‘2ä¸ªå°æ—¶ğŸ˜“ï¼‰

å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡å‘½ä»¤è¡Œçš„æ–¹å¼ã€‚
```javascriptt
// å¯åŠ¨é˜²ç«å¢™
systemctl start firewalld.service
// å¼€å¯ç«¯å£
firewall-cmd --zone=public --add-port=80/tcp --permanent
firewall-cmd --zone=public --add-port=443/tcp --permanent
// é‡å¯é˜²ç«å¢™
firewall-cmd --reload
```

#### 3. ç¼–è¾‘ nginx.conf æ–‡ä»¶ï¼Œé…ç½® SSL è§„åˆ™
ç¼–è¾‘ nginx.conf
```javascript
vi /usr/local/nginx/conf/nginx.conf
```

é…ç½®è½¬å‘è§„åˆ™
```javascript
server {
    # åŒæ—¶ç›‘å¬443å’Œ80ç«¯å£
    listen       80;
    listen       443 ssl;
    server_name  api.tianxiaohu.online;
    # è¯ä¹¦ç›®å½•
    ssl_certificate      /usr/local/nginx/cert/ssl/cert.pem;
    ssl_certificate_key  /usr/local/nginx/cert/ssl/cert.key;
    ssl_session_cache    shared:SSL:1m;
    ssl_session_timeout  5m;
    ssl_ciphers  HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers  on;
    # è½¬å‘è§„åˆ™
    location / {
        # æœåŠ¡å™¨æ¥å£åœ°å€
        proxy_pass http://127.0.0.1:8080; 
        add_header Access-Control-Allow-Origin *;
    }
}
```
é‡å¯ Nginx
```javascript
nginx -s reload
```

å¦‚æ­¤ï¼Œå¦‚æœæ“ä½œä¸å‡ºæ„å¤–ï¼Œé‚£ä¹ˆä½ å°±å¯ä»¥å¼€å¿ƒçš„ä½¿ç”¨ https è®¿é—®æ¥å£äº†ã€‚è¦ä¸è¦ç‚¹ä¸ªå³ä¸‹è§’èµä¸€æ¯å’–å•¡ï¼ŸğŸ˜ƒ


